<!DOCTYPE html>
<html lang="pt-br">
    <head>
        <meta charset="UTF-8">
        <title>Quem é esse Pokémon? (SVD Corrigido)</title>
        <link rel="stylesheet" type="text/css" href="style.css">
    </head>
    <body>

        <div class="card">
            <h1>Quem é esse Pokémon?</h1>
            <div class="stats">Componentes usados: <span id="compCount">0</span></div>
            
            <canvas id="canvas" width="96" height="96"></canvas>
            
            <div id="status">Iniciando...</div>

            <input type="text" id="guess" placeholder="Digite o nome..." disabled>
            <div class="controls">
                <button id="btnGuess" disabled>CHUTAR</button>
                <button id="btnSkip" disabled>PULAR</button>
            </div>
        </div>

        <script src="https://unpkg.com/pokeapi-js-wrapper/dist/index.js"></script>
        <script src="get_pokemon_data.js"></script>
        <script type="module">
            import {matriz, PCA, reconstrucao_melhor, reconstrucao} from './pca.js';
            // Configurações
            const POKE_SIZE = 96;
            const NUM_POKE_RIGHT = 3;
            const NUM_POKE_DOWN = 3;
            const WIDTH = POKE_SIZE * NUM_POKE_RIGHT;
            const HEIGHT = POKE_SIZE * NUM_POKE_DOWN;
            const POKE_TOTAL = NUM_POKE_DOWN * NUM_POKE_RIGHT;

            let pcaData = { r: null, g: null, b: null };

            let currentPokemon = [];
            let currentCorrect = 0;
            let currentK = 1;
            const MAX_K = 50;

            // Referências DOM
            const canvas = document.getElementById('canvas');
            const ctx = canvas.getContext('2d');
            const statusEl = document.getElementById('status');
            const inputEl = document.getElementById('guess');
            const btnGuess = document.getElementById('btnGuess');
            const btnSkip = document.getElementById('btnSkip');
            const compCountEl = document.getElementById('compCount');

            canvas.width = WIDTH;
            canvas.height = HEIGHT;

            // --------------------- Processamento dos Dados -----------------------

            function tratar_dados(data){
                return {
                    name: normalize(data.name),
                    img: data.sprites.other['official-artwork'].front_default,
                    crie: data.cries.latest,
                    found: false
                };
            }

            async function startGame() {
                resetUI();
                currentCorrect = 0;
                statusEl.innerText = "Procurando Pokémon selvagens...";
                statusEl.style.color = "#333";
                
                try {
                    for(let i = 0; i<NUM_POKE_DOWN; i++){
                        currentPokemon[i] = [];
                        console.log(currentCorrect[i])
                        for(let j = 0; j< NUM_POKE_RIGHT; i++){
                            const data = await get_random_pokemon();

                            currentPokemon[i][j] = tratar_dados(data);
                        }
                    }

                    statusEl.innerText = "Processando matemática...";
                    // Pequeno delay para a UI não travar antes de escrever o texto
                    setTimeout(() => processImage(), 10);

                } catch (e) {
                    statusEl.innerText = "Erro na conexão API :(";
                    console.error(e);
                    btnSkip.disabled = false;
                }
            }

            async function processImage() {
                let imgs = []
                for(let i = 0; i<NUM_POKE_DOWN; i++){
                    for(let j = 0; j< NUM_POKE_RIGHT; i++){
                        const img = new Image();
                        img.crossOrigin = "anonymous";
                        img.src = url;
                        imgs[i][j] = img;
                    }
                }
                
                imgs[NUM_POKE_DOWN-1][NUM_POKE_RIGHT-1].onload = () => {
                    ctx.clearRect(0, 0, WIDTH, HEIGHT);

                    for(let i = 0; i<NUM_POKE_DOWN; i++)
                        for(let j = 0; j<NUM_POKE_RIGHT; j++)
                            ctx.drawImage(imgs[i][j], i*POKE_SIZE, j*POKE_SIZE, WIDTH, HEIGHT);
                    
                    const imgData = ctx.getImageData(0, 0, WIDTH, HEIGHT);
                    
                    // Separa os canais de cor
                    const r = [], g = [], b = [];
                    for (let i = 0; i < HEIGHT; i++) {
                        r[i] = []; g[i] = []; b[i] = [];
                        for (let j = 0; j < WIDTH; j++) {
                            const idx = (i * WIDTH + j) * 4;
                            r[i][j] = imgData.data[idx];
                            g[i][j] = imgData.data[idx+1];
                            b[i][j] = imgData.data[idx+2];
                        }
                    }

                    try {
                        pcaData.r = PCA(matriz(r));
                        pcaData.g = PCA(matriz(g));
                        pcaData.b = PCA(matriz(b));

                        currentK = 2; // Começa bem difícil
                        reconstruct(currentK);
                        enableControls();
                        statusEl.innerText = "Quem são?";
                        console.log("Resposta (Cheat):", currentPokemon);
                    } catch(err) {
                        console.error(err);
                        statusEl.innerText = "Erro no cálculo PCA";
                    }
                };
            }

            function reconstruct(k) {
                compCountEl.innerText = k + " / " + WIDTH;
                
                // Reconstrói cada canal separadamente
                const newR = reconstrucao_melhor(pcaData.r, k);
                const newG = reconstrucao_melhor(pcaData.g, k);
                const newB = reconstrucao_melhor(pcaData.b, k);

                // Joga pixels de volta no canvas
                const finalImgData = ctx.createImageData(WIDTH, HEIGHT);
                for (let i = 0; i < HEIGHT; i++) {
                    for (let j = 0; j < WIDTH; j++) {
                        const idx = (i * WIDTH + j) * 4;
                        // .get(linha, coluna)
                        finalImgData.data[idx] = clamp(newR.get(i, j));
                        finalImgData.data[idx+1] = clamp(newG.get(i, j));
                        finalImgData.data[idx+2] = clamp(newB.get(i, j));
                        finalImgData.data[idx+3] = 255; // Alpha total
                    }
                }
                ctx.putImageData(finalImgData, 0, 0);
            }

            // --- Controles e UI ---

            function checkGuess() {
                const userGuess = normalize(inputEl.value);
                incorrect = true;
                for(let i = 0; i<NUM_POKE_DOWN; i++){
                    for(let j = 0; j<NUM_POKE_RIGHT; j++){
                        if(currentPokemon[i][j].found) continue;

                        if (userGuess === currentPokemon[i][j].name) {
                            score(i,j);
                            incorrect = false;
                            break;
                        }
                    }
                }

                if(incorrect){
                    inputEl.value = "";
                    inputEl.focus();
                    statusEl.innerText = "Errou! Melhorando a imagem...";
                    statusEl.style.color = "#e84118";
                    
                    // Aumenta a clareza
                    currentK += 3;
                    if(currentK > MAX_K) currentK = MAX_K;
                    reconstruct(currentK);
                    
                    setTimeout(() => {
                        statusEl.style.color = "#2f3542";
                        statusEl.innerText = "Tente de novo!";
                    }, 1000);
                }
            }

            function score(i, j){
                statusEl.innerText = `ACERTOU O ${currentPokemon[i][j].name.toUpperCase()}!!`;
                statusEl.style.color = "#44bd32";
                setTimeout(()=>{
                    statusEl.style.color = "#2f3542";
                    statusEl.innerText = "Continue!";
                }, 1000)

                currentPokemon[i][j].found = true;
                currentCorrect++;
                if(currentCorrect>=POKE_TOTAL){
                    endGame(true);
                }
            }

            function endGame(win) {
                disableControls();
                reconstruct(MAX_K); // Mostra imagem perfeita
                
                if(win) {
                    statusEl.innerText = `ACERTOU TODOS!!`;
                    statusEl.style.color = "#44bd32";
                } else {
                    statusEl.innerText = `Pouxa Pulou :(`;
                    statusEl.style.color = "#0097e6";
                }
                
                setTimeout(startGame, 4000);
            }

            function normalize(str) { 
                return str.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim(); 
            }

            function clamp(v) { return Math.max(0, Math.min(255, Math.round(v))); }

            function resetUI() {
                inputEl.value = "";
                disableControls();
                statusEl.style.color = "#2f3542";
                ctx.clearRect(0,0,WIDTH, HEIGHT);
            }

            function enableControls() {
                inputEl.disabled = false;
                btnGuess.disabled = false;
                btnSkip.disabled = false;
                inputEl.focus();
            }

            function disableControls() {
                inputEl.disabled = true;
                btnGuess.disabled = true;
                btnSkip.disabled = true;
            }

            // Event Listeners (Isso substitui o onclick do HTML)
            btnGuess.addEventListener('click', checkGuess);
            btnSkip.addEventListener('click', () => endGame(false));
            inputEl.addEventListener('keypress', (e) => {
                if(e.key === 'Enter') checkGuess();
            });

            // Inicia tudo
            startGame();
        </script>
    </body>
</html>